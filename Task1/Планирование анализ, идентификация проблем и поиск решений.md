# Текущие проблемы

- **Заказы «застревают»** — отсутствует прозрачность: неясно, где и почему теряются статусы заказов.
- **Высокая задержка в MES** — медленная загрузка главной страницы из-за тяжёлых запросов к заказам в статусах «новый» и «в работе».
- **Рост B2B API трафика без видимости** — сложно анализировать узкие места и восстанавливать цепочки обработки.
- **Недостаток наблюдаемости** — нет сквозных трейсов, логи фрагментированы, бизнес-метрики почти отсутствуют.
- **Отсутствие кэширования и рид-моделей** — все операции зависят от основной БД, что создаёт узкие места.

---

## Инициативы по улучшению системы

### 1. Сквозной трейсинг на базе OpenTelemetry

**Описание:**  
Внедрение единой системы трассировки для отслеживания жизненного цикла заказа через все сервисы.

**План действий:**
- Активация OpenTelemetry во всех ключевых сервисах: `Shop API`, `CRM API`, `MES API`, фоновые воркеры.
- Пропагация трейсов через HTTP и RabbitMQ с использованием заголовка `traceparent`.
- Детализация переходов статусов заказа через отдельные `spans` с атрибутами: `from_status`, `to_status`, `order_id`, `partner_id`.
- Настройка сбора трейсов в Jaeger / Tempo с семплированием:
    - 10–20% для штатного трафика,
    - 100% при ошибках.
- Разработка дашбордов для анализа:
    - Время пребывания в статусе (среднее, 95-й процентиль),
    - End-to-end время от `SUBMITTED` до `MANUFACTURING_STARTED`,
    - Возраст самого старого сообщения в очереди.

**Ожидаемый результат:**
- Время диагностики инцидента **менее 15 минут**.
- Покрытие ключевых бизнес-путей трассировкой **более 90%**.

---

### 2. Централизованное структурированное логирование

**Описание:**  
Объединение логов всех сервисов в единую систему с корреляцией по `order_id` и `trace_id`.

**План действий:**
- Внедрение единого формата логов: JSON с обязательными полями:
    - `service`, `env`, `order_id`, `partner_id`, `status`, `event_type`, `error_code`.
- Добавление корреляционных идентификаторов (`trace_id`, `order_id`) во все лог-записи.
- Централизованный сбор в Loki / ELK / YC Logging, ретеншн — 14–30 дней, маскирование PII.
- Настройка алёртов на критические события:
    - Рост 5xx ошибок,
    - Ошибки публикации/потребления сообщений,
    - Увеличение числа повторных попыток.

**Ожидаемый результат:**
- Полная цепочка обработки по `order_id` доступна **менее чем за 10 секунд**.
- Среднее время устранения инцидентов (MTTR) **сокращено в 2 раза**.

---

### 3. Кэширование и рид-модели для высоконагруженных сценариев

**Описание:**  
Снижение нагрузки на основную БД и ускорение критических UI-интерфейсов за счёт кэширования и денормализованных моделей.

**План действий:**

#### Для интерфейса MES:
- Создание рид-модели для заказов в статусах «новый» и «в работе»:
    - Реализация на Redis или отдельной таблице с индексами по `status`, `updated_at DESC`.
- Обновление модели через события (event-driven).
- Пагинация по `keyset` (cursor-based), использование `ZSET` в Redis или материализованных представлений.
- Атомарный захват заказа оператором:
    - Через `SET NX EX` в Redis,
    - Либо через версионирование записи в БД.

#### Для калькуляции и часто запрашиваемых данных:
- Кэширование результатов расчётов по хешу параметров (3D-модель + настройки).
- Использование Redis с TTL и стратегией `stale-while-revalidate`.
- Локальный in-memory кэш на воркерах для «горячих» данных.

#### Для HTTP-эндпоинтов:
- Включение `ETag` / `Last-Modified` для эндпоинтов списков и деталей.
- Короткий TTL (5–30 сек).
- Интеграция с CDN / edge-кэшированием при необходимости.

**Ожидаемый результат:**
- Время отклика главной страницы MES (TTFB) **< 300–500 мс** (95-й перцентиль).
- Снижение числа запросов к основной БД на **50–80%** для дашборда.
- Ускорение повторных расчётов цены в **3–10 раз**.

---

## Приоритеты внедрения

1. **Сквозной трейсинг (OTel) + базовые бизнес-метрики**  
   → Обеспечивает видимость системы и быструю диагностику.

2. **Рид-модель и кэширование для MES + атомарный захват**  
   → Прямо влияет на производительность операторов и сроки запуска в производство.

3. **Централизованные логи + алёртинг**  
   → Ускоряет расследование инцидентов и повышает стабильность поддержки.

---

## Целевая архитектура через пол года

- Все сервисы интегрированы с OpenTelemetry, бизнес-переходы статусов отслеживаются как отдельные спаны.
- Единые `trace_id` и `order_id` во всех логах.
- Логи централизованы, настроены дашборды по SLA и алёрты на задержки в очередях.
- Рид-модель для MES (Redis / материализованная таблица), `keyset`-пагинация, real-time обновление.
- Атомарный механизм захвата заказа оператором.
- Кэширование калькуляции и HTTP-кэш для часто читаемых эндпоинтов.

---

## Три пункта на пол года

1. **Сквозной трейсинг (OTel)**  
   → Быстро даёт понимание узких мест и точек потерь заказов.

2. **Рид-модель и кэш для MES + атомарный захват**  
   → Устраняет основную боль операторов, ускоряет обработку.

3. **Структурированные логи + алёртинг**  
   → Сокращает время простоя и ускоряет поиск причин инцидентов.

---

## Дальнейшие шаги

- **Надёжная обработка событий**: DLQ, re-drive, ретраи, идемпотентность.
- **Outbox / CDC** — для гарантии доставки событий.
- **Ограничение B2B API**: квоты по партнёру, ответы `429` + `Retry-After`.
- **Минимальная HA-конфигурация**:
    - 2+ реплики сервисов,
    - Managed Postgres с PITR,
    - Кластер RabbitMQ.
- **Оптимизация БД**: индексы по `status`, `updated_at`, партиционирование старых заказов.
- **Автотесты критических сценариев**: E2E и контрактные тесты («дымовые» проверки приёма и смены статусов).