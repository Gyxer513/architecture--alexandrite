# Мотивация

Необходима «лепка событий» по каждому заказу: где создан, где сменился статус, где застрял. Сейчас это невозможно быстро восстановить.

**Логи дадут:**
- Быстрое расследование инцидентов (поиск по `order_id`/`trace_id`)
- Аудит действий (`MANUFACTURING_APPROVED`, «захват» заказа оператором)
- Контроль интеграций (publish/consume/DLQ в RabbitMQ, загрузки файлов)
- Измерение эффекта кэширования и оптимизаций (MES дашборд, расчёт цены)

**Метрики, которые улучшатся благодаря логам:**

| Категория       | Метрики |
|-----------------|--------|
| **Технические** | - MTTR и MTTD (в 2–4 раза ниже)<br>- error-rate с разбивкой по маршрутам/партнёрам<br>- p95 времени ключевых операций (`submit`, `price`, `claim`) |
| **Бизнес**      | - Доля просрочек по переходам статусов с указанием ответственного звена<br>- Доля потерянных/дублированных B2B-заказов<br>- SLA партнёрского API |

---

## Где и какие логи собирать

**Обязательные системы:**
- Shop API, CRM API, MES API
- Все воркеры и outbox/relay
- RabbitMQ (DLQ/ретраи)
- API-gateway/ingress (партнёрский контур)
- PostgreSQL (ошибки/slow query/lock/deadlock)
- Объектное хранилище (успех/ошибка загрузок)

**Опционально (позже):**
- Фронтенды (ошибки JS, бизнес-события `submit`/`claim`)

---

## Список обязательных логов уровня INFO (структурированный JSON)

### Общие поля (во всех записях)
```
ts, level, 
service, env, 
version, 
instance, 
region/az
trace_id,
span_id, correlation_id
partner_id (ограниченный справочник), 
source=b2c|b2b
```


### События

| Событие | Поля |
|--------|------|
| `order_created` | `order_id`, `customer_type`, `items_count`, `cart_total?` |
| `order_status_changed` | `order_id`, `prev_status`, `new_status`, `actor=system|user|operator`, `reason`, `duration_ms_from_prev` |
| `price_calculated` | `order_id`, `input_hash`, `algo_version`, `duration_ms`, `price`, `cache_hit` |
| `manufacturing_approved` | `order_id`, `approved_by_role`, `comment?` |
| `order_claim_attempt` | `order_id`, `operator_hash`, `result=success|conflict|error`, `ttl_s` |
| `manufacturing_started/completed`, `packaging_started`, `shipped`, `closed` | `order_id`, `operator_hash?`, `duration_ms` |
| `api_access_log` | `route`, `method`, `http_status`, `duration_ms`, `bytes_in`, `bytes_out`, `client_type`, `partner_id?` |
| `mq_published` | `exchange`, `routing_key`, `message_id`, `order_id?`, `attempt` |
| `mq_consumed` | `queue`, `message_id`, `redelivered`, `processing_ms`, `result=ack|nack|retry|dlq` |
| `dlq_move` | `queue`, `message_id`, `reason`, `retries` |
| `dlq_redrive` | `queue`, `count`, `window`, `result=success|partial|failed` |
| `outbox_write` | `table`, `record_id`, `tx_id`<br>`outbox_publish`: `topic`, `record_id`, `result` |
| `idempotency_dedup` | `endpoint`, `key`, `discarded=true` |
| `file_upload_url_issued` | `order_id`, `file_id`, `mime`, `size_kb`<br>`file_upload_completed`: `file_id`, `size_kb`, `virus_scan=clean|infected` |
| `mes_dashboard_query` | `filter=status`, `page_size`, `duration_ms`, `row_count`, `cache_hit` |
| `cache_event` | `cache=price|mes_dashboard`, `key_hash`, `action=hit|miss|set|evict`, `ttl_s` |
| `reconciliation_report` | `totals_by_status`, `inconsistencies`, `fixed` |
| `db_migration_applied` | `migration_id`, `duration_ms`, `result` |
| `auth_login_success` / `auth_failed` (аудит) | `user_role`, `method`, `ip_hash` |

---

## Уровни логирования и когда их использовать

| Уровень | Когда использовать |
|--------|---------------------|
| **DEBUG** | Подробности бизнес-логики/параметров — только в dev/release, в prod кратковременно по фильтру (семплирование/по `order_id`) |
| **INFO** | Все бизнес-события из списка выше |
| **WARN** | Восстановимые проблемы и пред-инциденты: ретраи, медленные операции, применение квот/деградация, появление записей в DLQ, всплеск `idempotency_dedup` |
| **ERROR** | Неуспех после N ретраев; недоступность БД/очереди/хранилища; откат транзакций; нарушения целостности |
| **FATAL/CRITICAL** | Сервис не стартовал, сломалась миграция |
| **AUDIT** (отдельная категория) | Админ-действия, ручные исправления заказов и прав |

---

## Приоритет внедрения логирования и трейсинга

1. **Сразу:**  
   MES API, Shop API, CRM API, RabbitMQ, outbox/relay — и логи, и трейсинг (сквозной путь заказа)

2. **Далее:**  
   API-gateway/ingress и воркеры расчёта/кэшей — защита от всплесков, производительность

3. **Потом:**  
   PostgreSQL (ошибки/slow/locks), Object Storage

4. **Позже:**  
   Фронтенды (RUM)

---

## Предлагаемое решение (технологии и компоненты)

### Формат
- JSON, единая схема полей, низкая кардинальность
- В каждой записи — `trace_id`/`span_id`

### Сбор
- **Агенты:** Fluent Bit или Vector (DaemonSet) для контейнеров, агенты для VM
- Парсинг JSON/grok, добавление лейблов: `env`, `service`, `version`, `pod`

### Хранилище и анализ
- **Grafana Loki:** объектное хранилище для чёнков, ретеншн:
    - `prod`: 14–30 дней
    - `non-prod`: 7–14 дней
- **Grafana:** для Explore, дашбордов, алёртов
- Нативная корреляция с трейсами через **Tempo** по `trace_id`

### Практики
- **Логи → метрики:** использование recording rules (LogQL) для:
    - `error-rate`
    - `dlq_move`
    - `claim_conflict`
    - `idempotency_dedup`
- **Дашборды:**
    - «Жизненный цикл заказа»
    - «Очереди и DLQ»
    - «Партнёрский контур»
    - «MES дашборд»

---

## Безопасность логов

### Маскирование в пайплайне
- Удаление PII: ФИО, телефон, email, адрес
- Удаление секретов/токенов, тел запросов/ответов
- Допускаются: `order_id`, `correlation_id`, `trace_id`, `partner_id` (из справочника)
- Для операторов — `operator_hash` вместо `user_id`

### Шифрование и периметр
- TLS от агента до Loki
- Loki в приватной VPC
- Шифрование «на диске» (KMS)

### Доступы
- Через SSO (OIDC/SAML), RBAC:
    - **Support/Sales ops:** read-only дашборды без доступа к сырым логам
    - **Dev:** доступ к логам своих сервисов, только чтение в prod
    - **SRE:** полный read, настройка правил и ретеншна
    - **Admin:** администрирование системы

### Ретеншн
- `prod`: 14–30 дней
- `audit-канал`: до 90 дней
- `non-prod`: 7–14 дней
- Аудит входов и экспортов

### Надёжность
- Буфер в агенте
- Троттлинг при деградации
- Алёрт: «поток логов упал»

---

## Преобразование «сбора» в «анализ»

### Нормализация
- Единый ключ `event` и стандартные поля

### Логи → метрики
- Использование LogQL recording rules для:
    - `error-rate`
    - `dlq_move`
    - `retries`
    - `cache_hit ratio`
    - `claim_conflict`

### Алёртинг (Grafana Alerting)

| Алёрт | Условие | Приоритет |
|-------|--------|-----------|
| **Ошибки** | `error-rate > 2%` за 5 мин по сервису/маршруту | P1 |
| **DLQ** | Появление записей или рост >10/мин | P1 |
| **«Тишина» от сервиса** | Нет логов/heartbeats 5–10 мин | P2 |
| **Низкий cache hit** | `<60%` в течение 10 мин | P2 |
| **Конфликты claim** | Rate выше порога | P2 |
| **Аудит/безопасность** | Всплеск `auth_failed`, множественные логины | P2/P3 |

### Поиск аномалий
- **Спайк `order_created` или RPS партнёра:**  
  Текущий rate > 10× среднего за 1 час → возможно DDoS/ошибка интеграции  
  → Автоматически включить квоты/429 для `partner_id`, уведомить on-call

- **Всплеск `idempotency_dedup`:**  
  Проблема на стороне партнёра

- **Резкий рост ERROR по одному route:**  
  Автоматический rollback последнего релиза (если включён feature-flag)

### Runbooks
- Для каждого алёрта — шаги проверки, ссылки на дашборды/трейсы, команды `re-drive DLQ`, включение квот

---

## Критерии выбора технологии для логов (и обоснование)

| Критерий | ELK | OpenSearch | Splunk | Loki | Выбор |
|--------|-----|------------|--------|------|-------|
| **1. Лицензия и TCO** | Elastic License; часть функций платные; высокий TCO | Apache 2.0; дешевле; активное сообщество | Проприетарная; самый высокий TCO | OSS (AGPLv3); низкая стоимость хранения (S3) | **Loki** — минимальный TCO; OpenSearch — запасной вариант |
| **2. Масштабируемость и стоимость хранения** | Индексирует поля — дорого на терабайтах/сутки | Аналогично ELK | Масштабируется, но дорого | Индексирует лейблы, хранит чёнки — дёшево |  **Loki** |
| **3. Возможности запросов/аналитики** | Мощный полнотекст/агрегации | Мощный DSL, агрегации | SPL мощный, но закрытый | LogQL с парсингом и агрегациями, метрики из логов |  **Loki** достаточно; при сложных запросах — OpenSearch |
| **4. Интеграция с Observability-стеком** | Есть, но трейс-корреляция сложнее | Аналогично | Собственная экосистема | Нативная корреляция с Tempo/Grafana по `trace_id` |  **Loki + Tempo + Grafana** |
| **5. Операционная сложность** | Сложный кластер, JVM, индексы | Аналогично | Требует выделенной экспертизы | Проще; объектное хранилище; меньше DevOps-нагрузки |  **Loki** — подходит для 1 DevOps |
| **6. Безопасность и RBAC** | Зрелый RBAC/Spaces | Зрелый | Очень зрелая, но дорого | RBAC через Grafana, multi-tenant | **Loki + Grafana SSO/RBAC** достаточно |
| **7. Аномалии/ML** | Встроенный AD | Встроенный AD | Мощный ML Toolkit (платно) | Базовые аномалии правилами; Grafana ML (beta) |  **Loki** достаточно; при необходимости — OpenSearch AD |
| **8. Managed-варианты** | Есть (в облаках) | Есть | Splunk Cloud (дорого) | Можно на K8s + S3; есть Cloud (Grafana Cloud) | **Loki в K8s + YC Object Storage** |

---

## Итоговый выбор

**Стек:**

```text
Fluent Bit/Vector → Grafana Loki (S3-бэкенд) → Grafana
↓
Интеграция с Tempo и OpenTelemetry для трейс-корреляции
```


**Причины:**
- Низкий TCO
- Простая эксплуатация
- Нативная интеграция с метриками и трейсами
- Достаточные аналитические функции для структурированных событий

**Резервный вариант:**
- OpenSearch — при необходимости богатого полнотекстового поиска или ML-аномалий