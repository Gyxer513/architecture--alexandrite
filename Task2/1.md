# Мониторинг: Мотивация, Подход, Метрики

---

## Раздел: Мотивация

- Бизнес растёт, появляются партнёрские B2B-заказы.
- Растёт количество жалоб на **«застрявшие» или просроченные заказы** и **потерянные ответы партнёрам**.
- Без мониторинга **нельзя понять, где теряется время и информация**.
- Необходима **доказуемая работа SLA** для B2C/B2B: от «принял заказ» до «в работе / отгрузка». Это критично для контрактов.
- Команда должна **быстро локализовывать деградации** и находить узкие места:  
  `RabbitMQ`, `БД`, `API`, `кэш`, `рид-модели`.  
  Иначе — высокий **MTTR** (среднее время восстановления).
- Требуется **измерять эффект от кэширования и оптимизаций**, а также **планировать ёмкости** БД, очередей, объектного хранилища.

### Что это даст компании:

- **Снижение MTTD/MTTR** → меньше отмен, штрафов, простоев.
- **Прозрачные SLO** по ключевым путям заказа → выполнение договорных обязательств перед партнёрами.
- **Осознанное масштабирование** → экономия: не «раздуваем» мощности вслепую.
- **Быстрая проверка гипотез** по производительности (кэширование, релизы) без страха сломать систему.

---

## Раздел: Выбор подхода к мониторингу

Используем **комбинированный подход**:

| Область | Подход | Описание |
|--------|--------|--------|
| **API-сервисы**<br>(Shop API, CRM API, MES API, партнёрский вход) | **RED**<br>(Rate, Errors, Duration) | Покрывает запросно-ориентированную нагрузку |
| **Инфраструктурные ресурсы**<br>(PostgreSQL, RabbitMQ, compute, Redis, Object Storage) | **USE**<br>(Utilization, Saturation, Errors) | Контроль ресурсов и насыщения |
| **Пользовательский опыт и сквозная цепочка заказа** | **«Четыре золотых сигнала»** + **доменные SLI** | Время в статусе, доля просрочек, создание/смена статуса |

### Техническая реализация

- **OpenTelemetry** — метрики + трейсинг
- **Prometheus-совместимые экспортеры**
- **Централизованный сбор логов**
- **Grafana** — дашборды и алерты
- **Метрики — низкой кардинальности**
    -  **Использовать** `order_id`, `user_id` только в **логах и трейсах**
       

---

## Раздел: Метрики и ярлыки

> **Нотация**: тип/подход в скобках.  
> **Общие ярлыки** (почти для всех метрик):  
> `env`, `service`, `version`, `instance`, `region/az`  
> Для API: `method`, `route`, `http_status_class`  
> Для партнёров: `partner_id` (ограниченный список)  
> **Не использовать** `user_id`, `order_id` как ярлыки в метриках

---

### 1. RabbitMQ (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `rabbitmq_dead_letter_messages` | `gauge` | `queue`, `exchange`, `reason`, `env` | Потерянные / ядовитые сообщения → срочный разбор при росте |
| `rabbitmq_messages_in_flight` | `gauge` (ready, unacked, total) | `queue`, `consumer_group`, `env` | Бэклог и лаг потребителей → предиктор просрочек |
| `rabbitmq_oldest_message_age_seconds` | `gauge` | `queue`, `env` | Прямой сигнал задержки обработки |
| `rabbitmq_publish_rate` / `ack_rate` | `counter → rate` | `queue`, `env` | Дисбаланс между входом и выходом |
| `rabbitmq_consumer_errors` | `counter` | `queue`, `error_code`, `env` | Постоянные retry / фатальные ошибки потребителей |

---

### 2. API-сервисы: Shop API, CRM API, MES API (RED)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `api_requests_total` | `counter → rate` | `route`, `method`, `source=b2c|b2b`, `env` | Нагрузка, аномалии, планирование ёмкостей |
| `api_response_time_seconds` | `histogram` | `route`, `method`, `env` | Контроль перцентилей и SLO |
| `api_errors_5xx_total` | `counter` | `route`, `method`, `env` | Отказоустойчивость; расчёт error-rate |
| `api_success_2xx_total` | `counter` | `route`, `method`, `env` | Знаменатель для error-rate |
| `api_kilobytes_transferred` | `counter → rate` | `direction=in|out`, `route`, `env` | Пропускная способность, узкие места сети/CDN |
| `api_simultaneous_sessions` | `gauge` | `protocol=http|ws`, `env` | Пик соединений, лимиты |
| `api_requests_per_partner` | `counter → rate` | `partner_id`, `route`, `env` | Защита от «шумных» партнёров, квоты |
| `api_cache_hit_ratio` | `gauge` | `cache=price|mes_dashboard`, `env` | Эффективность кэша (цены, рид-модель) |

---

### 3. MES фронт/бек (Golden Signals + доменные SLI)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `mes_page_load_latency_seconds` | `histogram` | `page=dashboard`, `env` | UX операторов, корреляция с производительностью |
| `mes_claim_order_result_total` | `counter` | `result=success|conflict|error`, `env` | Гонки за заказы, справедливость распределения |
| `mes_claim_order_latency_seconds` | `histogram` | `env` | Время захвата заказа |
| `mes_orders_list_query_latency_seconds` | `histogram` | `filter=status`, `env` | Эффективность рид-модели и индексов |
| `mes_orders_list_rows_scanned` | `gauge` | `filter=status`, `env` | Количество просканированных строк → оптимизация запросов |

---

### 4. Бизнес-метрики заказа (SLI/SLO)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `orders_created_per_minute` | `counter → rate` | `source=shop|partner`, `env` | Входной поток B2C vs B2B |
| `orders_by_status` | `gauge` | `status`, `env` | Оперативное состояние системы |
| `oldest_order_age_seconds` | `gauge` | `status`, `env` | Выявление «застрявших» заказов |
| `order_transition_duration_seconds` | `histogram` | `transition`, `env`, `partner_id?` | Контроль SLA на критических этапах |
| `sla_breaches_total` | `counter` | `transition`, `partner_id?`, `env` | Управленческая метрика нарушений SLA |

> **Примеры переходов**:  
> `SUBMITTED → PRICE_CALCULATED`  
> `MANUFACTURING_APPROVED → MANUFACTURING_STARTED`  
> `PACKAGING → SHIPPED`  
> `SHIPPED → CLOSED`

---

### 5. Базы данных (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `db_connections` | `gauge` | `db=shop|mes`, `role=primary|replica`, `env` | Пул соединений, утечки |
| `db_memory_utilization_percent` | `gauge` | `db`, `env` | Давление на кэш, риск свапа |
| `db_size_bytes` | `gauge` | `db`, `env` | Планирование хранения, вакуум, партиции |
| `db_cpu_usage_percent` | `gauge` | `db`, `env` | Насыщение CPU |
| `db_iops` | `gauge` | `db`, `env` | Нагрузка на диски |
| `db_lock_wait_time_seconds` | `histogram` | `db`, `env` | Блокировки и конкуренция |

---

### 6. Приложения/инстансы (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `app_cpu_usage_percent` | `gauge` | `service`, `instance`, `env` | Автоскейлинг, перегрев |
| `app_memory_utilization_percent` | `gauge` | `service`, `instance`, `env` | OOM, утечки памяти |

---

### 7. Хранилище объектов (S3)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `s3_bucket_size_bytes` | `gauge` | `bucket`, `env` | Контроль объёма (особенно 3D-файлов), стоимость |
| `s3_upload_download_errors_total` | `counter` | `op=put|get`, `error_code`, `env` | Проблемы с загрузкой/выгрузкой моделей |
| `s3_upload_latency_seconds` | `histogram` | `op=put`, `env` | UX при загрузке 3D-моделей |

---

### 8. Очистка / качество данных

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `dlq_redrive_result_total` | `counter` | `queue`, `result`, `env` | Контроль восстановления из DLQ |
| `idempotency_deduplications_total` | `counter` | `source`, `env` | Фиксация дубликатов с партнёрских API |

---

## Пояснения по ярлыкам и кардинальности

-  **Обязательные базовые ярлыки**: `env`, `service`, `version`, `instance`
- **`route`** — нормализовать: `/orders/{id}`, `/users/{id}`
- **`partner_id`** — допустим (ограниченный список)
-  **`user_id`**, **`order_id`** — **не использовать в метриках** → только в **логах и трейсах**
-  **Latency histogram** — согласованные бакеты:  
  `0.005`, `0.02`, `0.05`, `0.1`, `0.2`, `0.5`, `1`, `3`, `10` секунд

---

## Примеры алертов

| Область | Условие | SLO |
|--------|--------|-----|
| **API** | p95 latency | `< 300 мс` (Shop/CRM), `< 500 мс` (MES) |
| **API** | error-rate (5xx) | `< 0.5%` за 15 минут |
| **RabbitMQ** | `age_of_oldest_message` | `< 60 сек` (для критичных очередей) |
| **RabbitMQ** | DLQ | `= 0` |
| **Бизнес** | `SUBMITTED → PRICE_CALCULATED` (p95) | `< 60 сек` |
| **Бизнес** | `MANUFACTURING_APPROVED → MANUFACTURING_STARTED` (p95) | `< 15 мин` |
| **Бизнес** | Заказы старше 21 дня в `MANUFACTURING_STARTED` | `= 0` |

---

## Итого

- **API-сервисы** → **RED**
- **БД / очереди / инстансы** → **USE**
- **Пользовательский опыт и жизненный цикл заказа** → **«4 золотых сигнала» + доменные SLI**


> **Ключевой принцип**: метрики должны быть **информативными, стабильными и безопасными по объёму**.