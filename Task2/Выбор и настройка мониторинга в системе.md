# Мониторинг: Мотивация, Подход, Метрики

---

## Раздел: Мотивация

- Бизнес растёт, появляются партнёрские B2B-заказы.
- Растёт количество жалоб на **«застрявшие» или просроченные заказы** и **потерянные ответы партнёрам**.
- Без мониторинга **нельзя понять, где теряется время и информация**.
- Необходима **доказуемая работа SLA** для B2C/B2B: от «принял заказ» до «в работе / отгрузка». Это критично для контрактов.
- Команда должна **быстро локализовывать деградации** и находить узкие места:  
  `RabbitMQ`, `БД`, `API`, `кэш`, `рид-модели`.  
  Иначе — высокий **MTTR** (среднее время восстановления).
- Требуется **измерять эффект от кэширования и оптимизаций**, а также **планировать ёмкости** БД, очередей, объектного хранилища.

### Что это даст компании:

- **Снижение MTTD/MTTR** → меньше отмен, штрафов, простоев.
- **Прозрачные SLO** по ключевым путям заказа → выполнение договорных обязательств перед партнёрами.
- **Осознанное масштабирование** → экономия: не «раздуваем» мощности вслепую.
- **Быстрая проверка гипотез** по производительности (кэширование, релизы) без страха сломать систему.

---

## Раздел: Выбор подхода к мониторингу

Используем **комбинированный подход**:

| Область | Подход | Описание |
|--------|--------|--------|
| **API-сервисы**<br>(Shop API, CRM API, MES API, партнёрский вход) | **RED**<br>(Rate, Errors, Duration) | Покрывает запросно-ориентированную нагрузку |
| **Инфраструктурные ресурсы**<br>(PostgreSQL, RabbitMQ, compute, Redis, Object Storage) | **USE**<br>(Utilization, Saturation, Errors) | Контроль ресурсов и насыщения |
| **Пользовательский опыт и сквозная цепочка заказа** | **«Четыре золотых сигнала»** + **доменные SLI** | Время в статусе, доля просрочек, создание/смена статуса |

### Техническая реализация

- **OpenTelemetry** — метрики + трейсинг
- **Prometheus-совместимые экспортеры**
- **Централизованный сбор логов**
- **Grafana** — дашборды и алерты
- **Метрики — низкой кардинальности**
    -  **Использовать** `order_id`, `user_id` только в **логах и трейсах**
       

---

## Раздел: Метрики и ярлыки

> **Нотация**: тип/подход в скобках.  
> **Общие ярлыки** (почти для всех метрик):  
> `env`, `service`, `version`, `instance`, `region/az`  
> Для API: `method`, `route`, `http_status_class`  
> Для партнёров: `partner_id` (ограниченный список)  
> **Не использовать** `user_id`, `order_id` как ярлыки в метриках

---

### 1. RabbitMQ (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `rabbitmq_dead_letter_messages` | `gauge` | `queue`, `exchange`, `reason`, `env` | Потерянные / ядовитые сообщения → срочный разбор при росте |
| `rabbitmq_messages_in_flight` | `gauge` (ready, unacked, total) | `queue`, `consumer_group`, `env` | Бэклог и лаг потребителей → предиктор просрочек |
| `rabbitmq_oldest_message_age_seconds` | `gauge` | `queue`, `env` | Прямой сигнал задержки обработки |
| `rabbitmq_publish_rate` / `ack_rate` | `counter → rate` | `queue`, `env` | Дисбаланс между входом и выходом |
| `rabbitmq_consumer_errors` | `counter` | `queue`, `error_code`, `env` | Постоянные retry / фатальные ошибки потребителей |

---

### 2. API-сервисы: Shop API, CRM API, MES API (RED)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `api_requests_total` | `counter → rate` | `route`, `method`, `source=b2c|b2b`, `env` | Нагрузка, аномалии, планирование ёмкостей |
| `api_response_time_seconds` | `histogram` | `route`, `method`, `env` | Контроль перцентилей и SLO |
| `api_errors_5xx_total` | `counter` | `route`, `method`, `env` | Отказоустойчивость; расчёт error-rate |
| `api_success_2xx_total` | `counter` | `route`, `method`, `env` | Знаменатель для error-rate |
| `api_kilobytes_transferred` | `counter → rate` | `direction=in|out`, `route`, `env` | Пропускная способность, узкие места сети/CDN |
| `api_simultaneous_sessions` | `gauge` | `protocol=http|ws`, `env` | Пик соединений, лимиты |
| `api_requests_per_partner` | `counter → rate` | `partner_id`, `route`, `env` | Защита от «шумных» партнёров, квоты |
| `api_cache_hit_ratio` | `gauge` | `cache=price|mes_dashboard`, `env` | Эффективность кэша (цены, рид-модель) |

---

### 3. MES фронт/бек (Golden Signals + доменные SLI)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `mes_page_load_latency_seconds` | `histogram` | `page=dashboard`, `env` | UX операторов, корреляция с производительностью |
| `mes_claim_order_result_total` | `counter` | `result=success|conflict|error`, `env` | Гонки за заказы, справедливость распределения |
| `mes_claim_order_latency_seconds` | `histogram` | `env` | Время захвата заказа |
| `mes_orders_list_query_latency_seconds` | `histogram` | `filter=status`, `env` | Эффективность рид-модели и индексов |
| `mes_orders_list_rows_scanned` | `gauge` | `filter=status`, `env` | Количество просканированных строк → оптимизация запросов |

---

### 4. Бизнес-метрики заказа (SLI/SLO)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `orders_created_per_minute` | `counter → rate` | `source=shop|partner`, `env` | Входной поток B2C vs B2B |
| `orders_by_status` | `gauge` | `status`, `env` | Оперативное состояние системы |
| `oldest_order_age_seconds` | `gauge` | `status`, `env` | Выявление «застрявших» заказов |
| `order_transition_duration_seconds` | `histogram` | `transition`, `env`, `partner_id?` | Контроль SLA на критических этапах |
| `sla_breaches_total` | `counter` | `transition`, `partner_id?`, `env` | Управленческая метрика нарушений SLA |

> **Примеры переходов**:  
> `SUBMITTED → PRICE_CALCULATED`  
> `MANUFACTURING_APPROVED → MANUFACTURING_STARTED`  
> `PACKAGING → SHIPPED`  
> `SHIPPED → CLOSED`

---

### 5. Базы данных (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `db_connections` | `gauge` | `db=shop|mes`, `role=primary|replica`, `env` | Пул соединений, утечки |
| `db_memory_utilization_percent` | `gauge` | `db`, `env` | Давление на кэш, риск свапа |
| `db_size_bytes` | `gauge` | `db`, `env` | Планирование хранения, вакуум, партиции |
| `db_cpu_usage_percent` | `gauge` | `db`, `env` | Насыщение CPU |
| `db_iops` | `gauge` | `db`, `env` | Нагрузка на диски |
| `db_lock_wait_time_seconds` | `histogram` | `db`, `env` | Блокировки и конкуренция |

---

### 6. Приложения/инстансы (USE)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `app_cpu_usage_percent` | `gauge` | `service`, `instance`, `env` | Автоскейлинг, перегрев |
| `app_memory_utilization_percent` | `gauge` | `service`, `instance`, `env` | OOM, утечки памяти |

---

### 7. Хранилище объектов (S3)

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `s3_bucket_size_bytes` | `gauge` | `bucket`, `env` | Контроль объёма (особенно 3D-файлов), стоимость |
| `s3_upload_download_errors_total` | `counter` | `op=put|get`, `error_code`, `env` | Проблемы с загрузкой/выгрузкой моделей |
| `s3_upload_latency_seconds` | `histogram` | `op=put`, `env` | UX при загрузке 3D-моделей |

---

### 8. Очистка / качество данных

| Метрика | Тип | Ярлыки | Зачем |
|--------|-----|--------|------|
| `dlq_redrive_result_total` | `counter` | `queue`, `result`, `env` | Контроль восстановления из DLQ |
| `idempotency_deduplications_total` | `counter` | `source`, `env` | Фиксация дубликатов с партнёрских API |

---

## Пояснения по ярлыкам и кардинальности

-  **Обязательные базовые ярлыки**: `env`, `service`, `version`, `instance`
- **`route`** — нормализовать: `/orders/{id}`, `/users/{id}`
- **`partner_id`** — допустим (ограниченный список)
-  **`user_id`**, **`order_id`** — **не использовать в метриках** → только в **логах и трейсах**
-  **Latency histogram** — согласованные бакеты:  
  `0.005`, `0.02`, `0.05`, `0.1`, `0.2`, `0.5`, `1`, `3`, `10` секунд

---

## Примеры алертов

| Область | Условие | SLO |
|--------|--------|-----|
| **API** | p95 latency | `< 300 мс` (Shop/CRM), `< 500 мс` (MES) |
| **API** | error-rate (5xx) | `< 0.5%` за 15 минут |
| **RabbitMQ** | `age_of_oldest_message` | `< 60 сек` (для критичных очередей) |
| **RabbitMQ** | DLQ | `= 0` |
| **Бизнес** | `SUBMITTED → PRICE_CALCULATED` (p95) | `< 60 сек` |
| **Бизнес** | `MANUFACTURING_APPROVED → MANUFACTURING_STARTED` (p95) | `< 15 мин` |
| **Бизнес** | Заказы старше 21 дня в `MANUFACTURING_STARTED` | `= 0` |

---

## Итого

- **API-сервисы** → **RED**
- **БД / очереди / инстансы** → **USE**
- **Пользовательский опыт и жизненный цикл заказа** → **«4 золотых сигнала» + доменные SLI**


> **Ключевой принцип**: метрики должны быть **информативными, стабильными и безопасными по объёму**.

---
# План действий (драфт ТЗ)

## Цель
Запустить наблюдаемость по единому стандарту, чтобы видеть поток заказов end-to-end, быстро искать причины сбоев и управлять ростом нагрузки.

---

## Шаг 1. Базовая платформа мониторинга

- Развернуть time-series хранилище и алёртинг: Prometheus + Alertmanager (в k8s или на отдельных VM), длительное хранение — Thanos с бэкендом в Yandex Object Storage.
- Развернуть Grafana и каталог дашбордов (структура папок: API, RabbitMQ, DB, Кэш, Бизнес-метрики, Инфраструктура).
- Развернуть систему трассировок: Tempo или Jaeger, с коллектором OpenTelemetry.
- Организовать централизованные логи: Loki + Promtail (или Vector), ретеншн — 14–30 дней, парсинг JSON-логов.
- Реализовать IaC: Terraform или Helm-чарты для всего стека; управление секретами — через YC Lockbox.

---

## Шаг 2. Инструментирование сервисов

- Внедрить OpenTelemetry SDK во все API и воркеры; обеспечить пропагацию контекста через HTTP и заголовки RabbitMQ (`traceparent`, `correlation_id`).
- Добавить доменные спаны:
    - Смена статуса заказа
    - Публикация/чтение события
    - Расчёт цены
    - Загрузка 3D-файла
- Экспортировать технические метрики (RED/USE) в Prometheus через эндпоинты `/metrics`.
- Обогащать логи атрибутами: `trace_id`, `span_id`, `order_id` (только в логах), `partner_id`, `status`, `error_code`; формат — JSON.

---

## Шаг 3. Экспортеры инфраструктуры

- Подключить RabbitMQ exporter: мониторинг очередей, DLQ, скорости publish/ack, возраст старейшего сообщения.
- Подключить PostgreSQL exporter для Shop DB и MES DB: соединения, блокировки, I/O, репликация, размер БД.
- Настроить экспортёр кэша (Redis, если используется): хиты/промахи, эвикции, использование памяти.
- Установить экспортёры на ноды/контейнеры: node_exporter, kube-state-metrics, cAdvisor.

---

## Шаг 4. Дашборды и SLO

- **API (RED)**: RPS, p95/p99 latency по route, error-rate 5xx/4xx.
- **RabbitMQ**: ready/unacked, age_of_oldest_message, DLQ, publish vs ack rate.
- **DB (USE)**: использованные соединения, CPU/IOPS, блокировки, долгие запросы.
- **Кэш**: hit ratio, память, эвикции.
- **Бизнес-метрики**:
    - Число заказов по статусам
    - Возраст старейшего заказа в статусе
    - Длительность переходов:
        - `SUBMITTED → PRICE_CALCULATED`
        - `MANUFACTURING_APPROVED → MANUFACTURING_STARTED`
        - `PACKAGING → SHIPPED`
        - `SHIPPED → CLOSED`
    - Нарушения SLA
- **MES UX**: latency дашборда и операции «claim order» (успех/конфликт/ошибка).

---

## Шаг 5. Алёрты и маршрутизация

- Определить SLI/SLO и настроить правила в Alertmanager с маршрутизацией в Slack/Telegram/почту.
- Уровни: Warning, Critical; автозакрытие при нормализации.
- Добавить аннотации в алёрты:
    - Ссылка на дашборд
    - Runbook
    - Версия последнего релиза

---

## Шаг 6. Runbooks и тесты

- Создать runbooks по сценариям:
    - Очередь растёт
    - DLQ не пуст
    - Всплеск ошибок 5xx
    - БД на пределе
    - Низкий cache hit
- Реализовать синтетические проверки:
    - HTTP-пробы ключевых эндпоинтов
    - Тестовая сквозная транзакция каждые 5 минут (в dev/release)
- Подготовить нагрузочные шаблоны и контрольные графики до/после релизов.

---

## Шаг 7. Безопасность и соответствие

- Маскирование PII в логах.
- Политики ретеншна: 14–30 дней.
- Контроль доступа по ролям; дашборды в режиме read-only для бизнес-пользователей.

---

## Шаг 8. Внедрение по продуктовым ролям

- Настроить дашборды для:
    - SRE/DevOps
    - Разработчиков
    - Операторов/менеджеров (бизнес-панель по SLA статусов)
- Провести обучение команд: работа с трейсами, логами, дашбордами.

---

# Показатели насыщенности (thresholds, обоснование, действия)

**Принцип**:  
Используем:
- USE (Utilization, Saturation, Errors) — для ресурсов
- RED / «четыре сигнала» — для API и бизнес-путей

**Общее правило**:  
Порог считается превышенным при устойчивом значении в течение 5–10 минут (для фильтрации шума).

---

## RabbitMQ

| Метрика | Порог | Обоснование | Действия |
|--------|-------|-------------|----------|
| Age of oldest message (сек) | Warning ≥ 60; Critical ≥ 300 | Прямая задержка обработки заказов | Автоскейлинг воркеров; если publish > ack > 10 мин — включить партнёрские квоты (429), инцидент P2, re-drive DLQ |
| Publish vs Ack rate (ratio) | Warning ≥ 1.2; Critical ≥ 1.5 (за 5 мин) | Рост очереди | Увеличить consumer concurrency, проверить ошибки потребителей, временно снизить ingest через API-gateway |
| DLQ size | Warning > 0; Critical рост >10/мин | Накопление ошибочных сообщений | Автосоздание тикета, запуск полуавтоматического re-drive, уведомление ответственного сервиса |

---

## PostgreSQL

| Метрика | Порог | Обоснование | Действия |
|--------|-------|-------------|----------|
| Connections used/max | Warning ≥ 80%; Critical ≥ 90% | Риск исчерпания пула соединений | Уменьшить timeouts, увеличить пул, включить квоты, инцидент P2; при Critical — масштабирование, отсечение тяжёлых запросов |
| CPU util | Warning ≥ 70% (10 мин); Critical ≥ 85% (10 мин) | Высокая нагрузка на CPU | Оптимизация плана запросов, вынос отчётных на реплику, увеличение класса инстанса |
| I/O saturation (util / avg latency) | Warning ≥ 60%; Critical ≥ 80% | Проблемы с диском | Уменьшить частоту чекпоинтов, включить кэширование, масштабировать диск/реплику |
| Lock wait p95 | Warning ≥ 100 мс; Critical ≥ 500 мс | Конфликты транзакций | Найти конфликтующие запросы, отменить долгие транзакции |

---

## API-сервисы (Shop/CRM/MES)

| Метрика | Порог | Обоснование | Действия |
|--------|-------|-------------|----------|
| Error-rate 5xx | Warning ≥ 0.5% (5 мин); Critical ≥ 2% (5 мин) | Сбои в работе сервиса | HPA, rollback, отключение фича-флагов, инцидент P1 при Critical |
| p95 latency | Shop/CRM: W ≥ 300 мс, C ≥ 800 мс; MES: W ≥ 500 мс, C ≥ 1200 мс | Замедление ответов | Проверить БД/кэш/очереди, включить деградацию, увеличить реплики |
| Simultaneous connections | Warning ≥ 80% лимита; Critical ≥ 90% | Риск отказа соединений | Увеличить лимиты на LB, добавить поды, включить rate limiting |

---

## Кэш (Redis / рид-модель)

| Метрика | Порог | Обоснование | Действия |
|--------|-------|-------------|----------|
| Cache hit ratio | Warning < 0.8; Critical < 0.6 (10 мин) | Рост нагрузки на БД | Проверить ключи/инвалидаторы, увеличить память, подогреть кэш, увеличить TTL |
| Memory used | Warning ≥ 85%; Critical ≥ 95% или evictions > 0 | Риск OOM и потерь | Масштабирование, шардирование, настройка maxmemory-policy |

---

## Бизнес-показатели насыщенности (сквозной поток)

| Статус | Порог (возраст старейшего заказа) | Действия |
|--------|----------------------------------|----------|
| SUBMITTED | Warning ≥ 10 мин; Critical ≥ 30 мин | Не начат расчёт/подтверждение |
| MANUFACTURING_APPROVED | Warning ≥ 60 мин; Critical ≥ 180 мин | Не стартовало производство |
| MANUFACTURING_STARTED | Warning ≥ 7 дней; Critical ≥ 21 день | Просрочка SLA — создать тикет P1/P2, уведомить менеджеров, запустить восстановление (переобработка, ручной ассайн) |

| Переход | SLA p95 | Действия |
|--------|--------|----------|
| SUBMITTED → PRICE_CALCULATED | Warning ≥ 60 с; Critical ≥ 180 с | Увеличить воркеры расчёта, приоритезация, ограничить B2B-поток |
| MANUFACTURING_APPROVED → MANUFACTURING_STARTED | Warning ≥ 15 мин; Critical ≥ 60 мин | Аналогично выше |

---

## Инфраструктура / ноды

| Метрика | Порог | Действия |
|--------|-------|----------|
| CPU pod util | Warning ≥ 70%; Critical ≥ 85% (10 мин) | HPA скейл-аут |
| Memory pod util | Warning ≥ 75%; Critical ≥ 90% | Предупреждение об OOM, скейл-аут или увеличение лимитов |
| Диск/FS util | Warning ≥ 80%; Critical ≥ 90% | Расширить PVC/том, включить очистку логов |

---

## Процедуры при превышении порога

### Маршрутизация
- **Warning** — в канал команды сервиса
- **Critical** — в on-call ротацию + «звонилка»

### Автоматические действия
- HPA / вертикальный скейлинг подов
- Увеличение числа консьюмеров очередей
- Включение rate limiting / квот в API-gateway для шумных партнёров
- Запуск re-drive DLQ (по белому списку)
- Создание тикета в трекере с автозаполнением: графики, версия релиза, виновные коммиты

### Эскалация
- **P1** — 24×7 дежурство
- **P2** — рабочее время, ускоренная реакция

### После инцидента
- Провести пост-мортем с анализом метрик до/после
- Зафиксировать задачи по предотвращению повторения

---

## Критерии приёмки

1. Все API, воркеры и брокеры публикуют метрики, трейсы и логи; дашборды отображают актуальные данные.
2. Алёрты корректно срабатывают на тестовых сценариях: «нагрузка + искусственная задержка/ошибка».
3. Время поиска причины «застрявшего» заказа — не более 15 минут (по трассе и логам).
4. Превышение показателей насыщенности приводит к автоматическим действиям и созданию тикета в течение 1–2 минут.